<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Head Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            overflow: hidden;
            height: 100vh;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
            position: relative;
        }
        h1 {
            text-align: center;
            color: #333;
            padding: 10px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .video-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #videoFeed {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .tracking-btn {
            background-color: #28a745;
        }
        .tracking-btn.active {
            background-color: #dc3545;
        }
        .capture-btn {
            background-color: #ffc107;
            color: black;
        }
        .status {
            text-align: center;
            font-size: 16px;
            padding: 5px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        .instructions {
            text-align: center;
            font-size: 14px;
            color: #6c757d;
            padding: 5px;
            background-color: #f8f9fa;
        }
        #centerDot {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: rgba(255, 0, 0, 0.7);
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
            display: none;
            transform: translate(-50%, -50%);
        }
        
        /* Keyboard status indicators */
        .keyboard-status {
            position: absolute;
            top: 80px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 50;
        }
        .key-indicator {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 14px;
        }
        .key-box {
            width: 30px;
            height: 30px;
            border: 2px solid #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            background-color: #f8f9fa;
            transition: all 0.2s;
        }
        .key-box.active.wasd {
            background-color: #ff6b35; /* Orange for WASD */
            border-color: #ff6b35;
            color: white;
        }
        .key-box.active.shift {
            background-color: #007bff; /* Blue for Shift */
            border-color: #007bff;
            color: white;
        }
        .key-label {
            font-size: 12px;
            color: #666;
        }
        
        /* Mobile warning */
        .mobile-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            z-index: 1000;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            flex-direction: column;
        }
        .mobile-warning h2 {
            margin-bottom: 20px;
            color: #ff6b6b;
        }
        .mobile-warning p {
            font-size: 18px;
            line-height: 1.5;
            max-width: 500px;
        }
        
        /* Car controls */
        .car-controls {
            background-color: #f8f9fa;
            padding: 10px;
            border-top: 1px solid #dee2e6;
        }
        .car-controls h3 {
            text-align: center;
            margin-bottom: 10px;
            color: #333;
        }
        .car-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 5px;
        }
        .car-btn {
            padding: 8px 15px;
            font-size: 14px;
        }
        .stop-btn {
            background-color: #dc3545;
        }
        
        @media (max-width: 768px) {
            .container {
                display: none;
            }
            .mobile-warning {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Warning -->
    <div class="mobile-warning">
        <h2>Desktop Only</h2>
        <p>This control interface is designed for desktop use only. Please access this page from a computer with a keyboard to control the robot.</p>
        <p>ðŸ“±ðŸš« â†’ ðŸ’»âœ…</p>
    </div>

    <div class="container">
        <h1>Robot Head & Car Control</h1>
        
        <!-- Keyboard Status Indicators -->
        <div class="keyboard-status">
            <div class="key-indicator">
                <div class="key-box" id="keyW">W</div>
                <span>Forward</span>
            </div>
            <div class="key-indicator">
                <div class="key-box" id="keyA">A</div>
                <span>Left</span>
            </div>
            <div class="key-indicator">
                <div class="key-box" id="keyS">S</div>
                <span>Backward</span>
            </div>
            <div class="key-indicator">
                <div class="key-box" id="keyD">D</div>
                <span>Right</span>
            </div>
            <div class="key-indicator">
                <div class="key-box" id="keyShift">Shift</div>
                <div>
                    <span>Turbo Mode</span>
                    <div class="key-label">(Fast speed)</div>
                </div>
            </div>
        </div>
        
        <div class="video-container" id="videoContainer">
            <img id="videoFeed" src="{{ url_for('video_feed') }}" alt="Camera Feed">
            <div id="centerDot"></div>
        </div>
        
        <div class="instructions">
            Press ESC to exit control mode | Move mouse to control head | Use WASD to control car
        </div>
        
        <div class="car-controls">
            <h3>Car Controls (WASD)</h3>
            <div class="car-buttons">
                <button class="car-btn" onclick="carControl('forward')" id="btnForward">Forward (W)</button>
                <button class="car-btn" onclick="carControl('backward')" id="btnBackward">Backward (S)</button>
                <button class="car-btn" onclick="carControl('left')" id="btnLeft">Left (A)</button>
                <button class="car-btn" onclick="carControl('right')" id="btnRight">Right (D)</button>
                <button class="car-btn stop-btn" onclick="carControl('stop')" id="btnStop">Stop</button>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="resetPosition()" id="btnReset">Reset Position</button>
            <button id="trackingBtn" class="tracking-btn" onclick="toggleTracking()">
                Enable Control
            </button>
            <button class="capture-btn" onclick="captureImage()" id="btnCapture">Capture Image</button>
        </div>
        
        <div class="status">
            Position: X: <span id="posX">0</span>, Y: <span id="posY">0</span> | 
            Control: <span id="controlStatus">Disabled</span>
        </div>
    </div>

    <script>
        let isTracking = false;
        let isPointerLocked = false;
        
        const videoContainer = document.getElementById('videoContainer');
        const videoFeed = document.getElementById('videoFeed');
        const centerDot = document.getElementById('centerDot');
        const posX = document.getElementById('posX');
        const posY = document.getElementById('posY');
        const trackingBtn = document.getElementById('trackingBtn');
        const controlStatus = document.getElementById('controlStatus');
        
        // Keyboard elements
        const keyW = document.getElementById('keyW');
        const keyA = document.getElementById('keyA');
        const keyS = document.getElementById('keyS');
        const keyD = document.getElementById('keyD');
        const keyShift = document.getElementById('keyShift');
        
        // Button elements
        const btnForward = document.getElementById('btnForward');
        const btnBackward = document.getElementById('btnBackward');
        const btnLeft = document.getElementById('btnLeft');
        const btnRight = document.getElementById('btnRight');
        const btnStop = document.getElementById('btnStop');
        const btnReset = document.getElementById('btnReset');
        const btnCapture = document.getElementById('btnCapture');
        
        // Update button states based on tracking
        function updateButtonStates() {
            const disabled = !isTracking;
            btnForward.disabled = disabled;
            btnBackward.disabled = disabled;
            btnLeft.disabled = disabled;
            btnRight.disabled = disabled;
            btnStop.disabled = disabled;
            btnReset.disabled = disabled;
            btnCapture.disabled = disabled;
        }
        
        // Event handlers
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);
        document.addEventListener('pointerlockchange', handlePointerLockChange);
        document.addEventListener('mozpointerlockchange', handlePointerLockChange);
        document.addEventListener('webkitpointerlockchange', handlePointerLockChange);
        
        function handlePointerLockChange() {
            isPointerLocked = document.pointerLockElement === videoContainer ||
                             document.mozPointerLockElement === videoContainer ||
                             document.webkitPointerLockElement === videoContainer;
            
            if (isPointerLocked) {
                // Pointer lock successfully acquired
                centerDot.style.display = 'block';
                centerDot.style.left = '50%';
                centerDot.style.top = '50%';
                videoFeed.style.cursor = 'none';
            } else {
                // Pointer lock lost
                centerDot.style.display = 'none';
                videoFeed.style.cursor = 'default';
                if (isTracking) {
                    disableTracking();
                }
            }
        }
        
        function handleMouseMove(e) {
            if (!isTracking || !isPointerLocked) return;
            
            // Use relative movement for control
            const dx = e.movementX || 0;
            const dy = e.movementY || 0;
            
            if (dx !== 0 || dy !== 0) {
                updatePosition(dx, dy);
            }
        }
        
        function handleKeyDown(e) {
            if (!isTracking) return;
            
            const key = getKeyFromEvent(e);
            if (key) {
                e.preventDefault();
                sendKeyEvent(key, true, 'press');
                updateKeyIndicator(key, true);
            }
            
            // Handle ESC to exit control mode
            if (e.key === 'Escape' || e.keyCode === 27) {
                if (isTracking) {
                    disableTracking();
                }
            }
        }
        
        function handleKeyUp(e) {
            if (!isTracking) return;
            
            const key = getKeyFromEvent(e);
            if (key) {
                e.preventDefault();
                sendKeyEvent(key, false, 'release');
                updateKeyIndicator(key, false);
            }
        }
        
        function getKeyFromEvent(e) {
            switch(e.key.toLowerCase()) {
                case 'w': return 'w';
                case 'a': return 'a';
                case 's': return 's';
                case 'd': return 'd';
                case 'shift': return 'shift';
                case 'control': return 'ctrl';
                default: return null;
            }
        }
        
        function updateKeyIndicator(key, isActive) {
            const keyElement = {
                'w': keyW,
                'a': keyA,
                's': keyS,
                'd': keyD,
                'shift': keyShift
            }[key];
            
            if (keyElement) {
                if (isActive) {
                    keyElement.classList.add('active');
                    if (key === 'shift') {
                        keyElement.classList.add('shift');
                    } else {
                        keyElement.classList.add('wasd');
                    }
                } else {
                    keyElement.classList.remove('active', 'wasd', 'shift');
                }
            }
        }
        
        function updatePosition(dx, dy) {
            fetch('/api/position', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ dx: dx, dy: dy })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    posX.textContent = Math.round(data.x);
                    posY.textContent = Math.round(data.y);
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        function resetPosition() {
            if (!isTracking) return;
            
            fetch('/api/reset', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    posX.textContent = data.x;
                    posY.textContent = data.y;
                }
            });
        }
        
        function carControl(action) {
            if (!isTracking) return;
            
            let speed = 0;
            let steering = 0;
            
            switch(action) {
                case 'forward':
                    speed = 0.5;
                    break;
                case 'backward':
                    speed = -0.5;
                    break;
                case 'left':
                    steering = -0.5;
                    break;
                case 'right':
                    steering = 0.5;
                    break;
                case 'stop':
                    fetch('/api/car/stop', { method: 'POST' });
                    return;
            }
            
            fetch('/api/car/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ speed: speed, steering: steering })
            });
        }
        
        function toggleTracking() {
            if (isTracking) {
                disableTracking();
            } else {
                enableTracking();
            }
        }
        
        function enableTracking() {
            // Request pointer lock on the container
            videoContainer.requestPointerLock = videoContainer.requestPointerLock || 
                                              videoContainer.mozRequestPointerLock ||
                                              videoContainer.webkitRequestPointerLock;
            
            if (videoContainer.requestPointerLock) {
                videoContainer.requestPointerLock();
                
                // Update UI immediately
                isTracking = true;
                trackingBtn.textContent = 'Disable Control';
                trackingBtn.classList.add('active');
                controlStatus.textContent = 'Enabled';
                controlStatus.style.color = 'green';
                
                // Enable buttons
                updateButtonStates();
                
                // Notify server
                fetch('/api/tracking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tracking: true })
                });
            } else {
                alert('Pointer Lock API is not supported in your browser');
            }
        }
        
        function disableTracking() {
            // Exit pointer lock
            document.exitPointerLock = document.exitPointerLock || 
                                      document.mozExitPointerLock ||
                                      document.webkitExitPointerLock;
            
            if (document.exitPointerLock) {
                document.exitPointerLock();
            }
            
            // Update UI
            isTracking = false;
            trackingBtn.textContent = 'Enable Control';
            trackingBtn.classList.remove('active');
            controlStatus.textContent = 'Disabled';
            controlStatus.style.color = 'red';
            
            // Disable buttons
            updateButtonStates();
            
            // Reset key indicators
            updateKeyIndicator('w', false);
            updateKeyIndicator('a', false);
            updateKeyIndicator('s', false);
            updateKeyIndicator('d', false);
            updateKeyIndicator('shift', false);
            
            // Stop car when disabling control
            fetch('/api/car/stop', { method: 'POST' });
            
            // Notify server
            fetch('/api/tracking', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ tracking: false })
            });
        }
        
        function captureImage() {
            if (!isTracking) return;
            
            fetch('/api/capture', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Image captured successfully!');
                } else {
                    alert('Error capturing image: ' + data.error);
                }
            });
        }
        
        function sendKeyEvent(key, state, action) {
            fetch('/api/keyboard', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    key: key,
                    state: state,
                    action: action
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Keyboard event error:', data.error);
                }
            })
            .catch(error => console.error('Error sending key event:', error));
        }
        
        // Auto-update status
        setInterval(() => {
            fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                posX.textContent = Math.round(data.x);
                posY.textContent = Math.round(data.y);
                
                if (data.tracking_enabled !== isTracking) {
                    isTracking = data.tracking_enabled;
                    if (isTracking) {
                        enableTracking();
                    } else {
                        disableTracking();
                    }
                }
            });
        }, 1000);
        
        // Initialize
        updateButtonStates();
    </script>
</body>
</html>