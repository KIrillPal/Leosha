<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Head Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            overflow: hidden;
            height: 100vh;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
        }
        h1 {
            text-align: center;
            color: #333;
            padding: 10px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .video-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        #videoFeed {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .tracking-btn {
            background-color: #28a745;
        }
        .tracking-btn.active {
            background-color: #dc3545;
        }
        .capture-btn {
            background-color: #ffc107;
            color: black;
        }
        .status {
            text-align: center;
            font-size: 16px;
            padding: 5px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        .instructions {
            text-align: center;
            font-size: 14px;
            color: #6c757d;
            padding: 5px;
            background-color: #f8f9fa;
        }
        #centerDot {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: rgba(255, 0, 0, 0.7);
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
            display: none;
            transform: translate(-50%, -50%);
        }
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Robot Head Control</h1>
        
        <div class="video-container" id="videoContainer">
            <img id="videoFeed" src="{{ url_for('video_feed') }}" alt="Camera Feed">
            <div id="centerDot"></div>
        </div>
        
        <div class="instructions">
            Press ESC to exit control mode | Move mouse to control head
        </div>
        
        <div class="controls">
            <button onclick="resetPosition()">Reset Position</button>
            <button id="trackingBtn" class="tracking-btn" onclick="toggleTracking()">
                Enable Control
            </button>
            <button class="capture-btn" onclick="captureImage()">
                Capture Image
            </button>
        </div>
        
        <div class="status">
            Position: X: <span id="posX">0</span>, Y: <span id="posY">0</span> | 
            Control: <span id="controlStatus">Disabled</span>
        </div>
    </div>

    <script>
        let isTracking = false;
        let isPointerLocked = false;
        
        const videoContainer = document.getElementById('videoContainer');
        const videoFeed = document.getElementById('videoFeed');
        const centerDot = document.getElementById('centerDot');
        const posX = document.getElementById('posX');
        const posY = document.getElementById('posY');
        const trackingBtn = document.getElementById('trackingBtn');
        const controlStatus = document.getElementById('controlStatus');
        
        // Event handlers
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('pointerlockchange', handlePointerLockChange);
        document.addEventListener('mozpointerlockchange', handlePointerLockChange);
        document.addEventListener('webkitpointerlockchange', handlePointerLockChange);
        
        function handlePointerLockChange() {
            isPointerLocked = document.pointerLockElement === videoContainer ||
                             document.mozPointerLockElement === videoContainer ||
                             document.webkitPointerLockElement === videoContainer;
            
            if (isPointerLocked) {
                // Pointer lock successfully acquired
                centerDot.style.display = 'block';
                centerDot.style.left = '50%';
                centerDot.style.top = '50%';
                videoFeed.style.cursor = 'none';
            } else {
                // Pointer lock lost
                centerDot.style.display = 'none';
                videoFeed.style.cursor = 'default';
                if (isTracking) {
                    disableTracking();
                }
            }
        }
        
        function handleMouseMove(e) {
            if (!isTracking || !isPointerLocked) return;
            
            // Use relative movement for control
            const dx = e.movementX || 0;
            const dy = e.movementY || 0;
            
            if (dx !== 0 || dy !== 0) {
                updatePosition(dx, dy);
            }
        }
        
        function handleKeyDown(e) {
            if (e.key === 'Escape' || e.keyCode === 27) {
                if (isTracking) {
                    disableTracking();
                }
            }
        }
        
        function updatePosition(dx, dy) {
            fetch('/api/position', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ dx: dx, dy: dy })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    posX.textContent = Math.round(data.x);
                    posY.textContent = Math.round(data.y);
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        function resetPosition() {
            fetch('/api/reset', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    posX.textContent = data.x;
                    posY.textContent = data.y;
                }
            });
        }
        
        function toggleTracking() {
            if (isTracking) {
                disableTracking();
            } else {
                enableTracking();
            }
        }
        
        function enableTracking() {
            // Request pointer lock on the container, not the image
            videoContainer.requestPointerLock = videoContainer.requestPointerLock || 
                                              videoContainer.mozRequestPointerLock ||
                                              videoContainer.webkitRequestPointerLock;
            
            if (videoContainer.requestPointerLock) {
                videoContainer.requestPointerLock();
                
                // Update UI immediately
                isTracking = true;
                trackingBtn.textContent = 'Disable Control';
                trackingBtn.classList.add('active');
                controlStatus.textContent = 'Enabled';
                controlStatus.style.color = 'green';
                
                // Notify server
                fetch('/api/tracking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tracking: true })
                });
            } else {
                alert('Pointer Lock API is not supported in your browser');
            }
        }
        
        function disableTracking() {
            // Exit pointer lock
            document.exitPointerLock = document.exitPointerLock || 
                                      document.mozExitPointerLock ||
                                      document.webkitExitPointerLock;
            
            if (document.exitPointerLock) {
                document.exitPointerLock();
            }
            
            // Update UI
            isTracking = false;
            trackingBtn.textContent = 'Enable Control';
            trackingBtn.classList.remove('active');
            controlStatus.textContent = 'Disabled';
            controlStatus.style.color = 'red';
            
            // Notify server
            fetch('/api/tracking', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ tracking: false })
            });
        }
        
        function captureImage() {
            fetch('/api/capture', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Image captured successfully!');
                } else {
                    alert('Error capturing image: ' + data.error);
                }
            });
        }
        
        // Auto-update status
        setInterval(() => {
            fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                posX.textContent = Math.round(data.x);
                posY.textContent = Math.round(data.y);
            });
        }, 1000);
    </script>
</body>
</html>